# Фильтр Калмана
Фильтр калмана реализован в пакете `object_detector`

Код скрипта [kalman_filter.cpp](https://github.com/MikeS96/autonomous_landing_uav/blob/master/object_detector/src/kalman_filter.cpp) 

Данный скрипт представляет собой реализацию линейного фильтра Калмана для оценки состояния объекта. Его основное предназначение — обработка поступающих наблюдаемых данных о состоянии объекта, таких как координаты центра, ширина, высота и угол ориентации, и последующее предсказание этих параметров с учетом предыдущих значений и моделей движения.

Реализован в виде класса `Kalman`, содержащего внутренние переменные для хранения ковариационных матриц, векторов состояния, наблюдений и шумов, а также матриц перехода и наблюдения, необходимых для фильтра Калмана. При инициализации класса происходит задание начальных значений всех необходимых матриц. В частности, матрица перехода `A` моделирует линейное движение с постоянной скоростью и временем обновления `dt = 0.1`. Состояние объекта моделируется десятиразмерным вектором, включающим координаты центра, ширину, высоту и угол, а также их производные по времени. Входной сигнал представляет собой сообщение ROS пользовательского типа `object_detector::States`, содержащее наблюдаемые параметры объекта.

При первом входящем сообщении с наблюдаемыми параметрами объект инициализирует вектор состояния нулями для производных и значениями из наблюдений для остальных параметров. Начиная со второго входящего сообщения, реализуются два этапа фильтра Калмана: предсказание и обновление. Этап предсказания использует матрицу перехода `A` для вычисления новой аппроксимации состояния и соответствующей ковариационной матрицы. На этапе обновления производится вычисление отклонения наблюдений от предсказанного состояния, расчет инновации, ковариации инновации и усиления Калмана, после чего состояние уточняется с учетом полученных измерений. Однако уточнение выполняется только в том случае, если наблюдаемые значения координат и размеров положительны, то есть являются валидными.

Результат фильтрации, то есть оцененные параметры состояния объекта, публикуется в виде ROS-сообщения в топик `/predicted_states`.



---

### Начальные условия

Начальная ковариация апостериорной ошибки \(\mathbf{P}_0\) устанавливается диагональной матрицей:

$$
\mathbf{P}_0 = \operatorname{diag}(2, 2, 5, 5, 5.625, 1e{-3}, 1e{-3}, 1e{-3}, 1e{-3}, 1e{-3})
$$

Это задаёт начальную степень уверенности в состоянии.


### 1. Вектор состояния

Пусть состояние объекта описывается 10-мерным вектором состояния:

$$
\mathbf{x}_k = 
\begin{bmatrix}
X_c \\
Y_c \\
W \\
H \\
\Theta \\
\dot{X}_c \\
\dot{Y}_c \\
\dot{W} \\
\dot{H} \\
\dot{\Theta}
\end{bmatrix}
\in \mathbb{R}^{10}
$$

где:

* \(X_c, Y_c\)  — координаты центра объекта,
* \(W, H\)  — ширина и высота объекта,
* \(\Theta\)  — угол поворота,
* \(\dot{X}_c, \dot{Y}_c, \dot{W}, \dot{H}, \dot{\Theta}\)  — производные этих величин по времени (скорости).


### 2. Уравнение перехода (динамика)


Динамика описывается моделью линейного движения с постоянной скоростью:

$$
\mathbf{x}_{k} = \mathbf{A} \mathbf{x}_{k-1} + \mathbf{w}_{k-1}, \quad \mathbf{w}_{k-1} \sim \mathcal{N}(0, \mathbf{Q})
$$

где:

* \(\mathbf{A} \in \mathbb{R}^{10 \times 10}\) — матрица перехода,
* \(\mathbf{w}_{k-1}\) — случайный шум процесса, с нулевым средним и ковариацией \(\mathbf{Q}\).

Матрица \(\mathbf{A}\)  имеет следующий вид (при \(\Delta t = 0.1\)):

$$
\mathbf{A} = 
\begin{bmatrix}
1 & 0 & 0 & 0 & 0 & \Delta t & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 & 0 & \Delta t & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 & 0 & 0 & \Delta t & 0 & 0 \\
0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & \Delta t & 0 \\
0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & \Delta t \\
0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 \\
\end{bmatrix}
$$

Матрица описывает динамику объекта во времени, то есть как состояние \(\mathbf{x}\) изменяется от шага \(k-1\) к шагу \(k\) без учёта наблюдений. Верхняя половина \(\mathbf{A}\) добавляет вклад скоростей в позиции, размеры и угол. Нижняя половина — просто единичная матрица (скорости считаются постоянными).


### 3. Уравнение наблюдения

Сенсор предоставляет только первые 5 компонент из состояния. Это задаётся уравнением наблюдения:

$$
\mathbf{z}_k = \mathbf{H} \mathbf{x}_k + \mathbf{v}_k, \quad \mathbf{v}_k \sim \mathcal{N}(0, \mathbf{R})
$$

где:

* \(\mathbf{z}_k \in \mathbb{R}^5\) — вектор наблюдаемых данных,
* \(\mathbf{H} \in \mathbb{R}^{5 \times 10}\) — матрица наблюдения,
* \(\mathbf{v}_k\) — шум измерений, с ковариацией \(\mathbf{R}\).

Матрица \(\mathbf{H}\) выглядит так:

$$
\mathbf{H} = 
\begin{bmatrix}
1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 \\
\end{bmatrix}
$$


### 4. Ковариации

#### 4.1. Ковариация априорной ошибки:
Она описывает  неопределённость в динамике модели (например, ускорения).
$$
\mathbf{P}_{k|k-1} = \mathbf{A} \mathbf{P}_{k-1|k-1} \mathbf{A}^\top + \mathbf{Q}
$$

где:

* \(\mathbf{P}_{k|k-1}\) — ковариация предсказанного состояния,
* \(\mathbf{Q} \in \mathbb{R}^{10 \times 10}\) — ковариация шума процесса, типично:

  $$
  \mathbf{Q} = q \cdot \mathbf{I}_{10}, \quad q = 1 \times 10^{-4}
  $$

#### 4.2. Ковариация измерения:

$$
\mathbf{R} = 
\begin{bmatrix}
1\times 10^{-4} & 0 & 0 & 0 & 0 \\
0 & 1\times 10^{-4} & 0 & 0 & 0 \\
0 & 0 & 1\times 10^{-2} & 0 & 0 \\
0 & 0 & 0 & 1\times 10^{-2} & 0 \\
0 & 0 & 0 & 0 & 1\times 10^{-2} \\
\end{bmatrix}
$$


### 5. Этапы фильтра Калмана

#### 5.1. Прогноз (Prediction)

$$
\hat{\mathbf{x}}_{k|k-1} = \mathbf{A} \hat{\mathbf{x}}_{k-1|k-1}
$$

$$
\mathbf{P}_{k|k-1} = \mathbf{A} \mathbf{P}_{k-1|k-1} \mathbf{A}^\top + \mathbf{Q}
$$

#### 5.2. Обновление (Correction)

Инновация (новизна):

$$
\mathbf{y}_k = \mathbf{z}_k - \mathbf{H} \hat{\mathbf{x}}_{k|k-1}
$$

Ковариация инновации:

$$
\mathbf{S}_k = \mathbf{H} \mathbf{P}_{k|k-1} \mathbf{H}^\top + \mathbf{R}
$$

Калмановское усиление:

$$
\mathbf{K}_k = \mathbf{P}_{k|k-1} \mathbf{H}^\top \mathbf{S}_k^{-1}
$$

Обновлённая оценка состояния:

$$
\hat{\mathbf{x}}_{k|k} = \hat{\mathbf{x}}_{k|k-1} + \mathbf{K}_k \mathbf{y}_k
$$

Обновлённая ковариация:

$$
\mathbf{P}_{k|k} = (\mathbf{I} - \mathbf{K}_k \mathbf{H}) \mathbf{P}_{k|k-1}
$$
